language: c
compiler: gcc

sudo: required

# Set up apt install configuration
addons:
    apt:
      sources:
          - ubuntu-toolchain-r-test
      packages:
          - gcc-7
          - g++-7

services:
    - docker

jobs:
    include:
        - stage: build docker image
          before_script: &update
              # Link newest version of gcc create by the addon
              - sudo ln -s /usr/bin/gcc-7 /usr/local/bin/gcc
              - sudo ln -s /usr/bin/g++-7 /usr/local/bin/g++
              # Export CC and CXX to tell cmake which compiler to use
              - export CC=/usr/bin/gcc-7
              - export CXX=/usr/bin/g++-7
              # Check versions of gcc, g++ and cmake
              - gcc -v && g++ -v && cmake --version
              # Ensure the latest version of docker is installed
              - sudo apt-get update
              - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce
              - docker --version
              - env > .env
          script:
              - echo "ENV GIT_SHA ${TRAVIS_COMMIT}" >> Dockerfile
              - echo "ENV MACHINE_ID ${MACHINE_ID}" >> Dockerfile
              - echo "$(git log -1 ${TRAVIS_COMMIT})" > COMMITINFO
                # Build container for current user
              - |
                  docker build \
                  --build-arg DOCKER_USER=$USER \
                  --build-arg DOCKER_USER_UID=`id -u` \
                  --build-arg DOCKER_USER_GID=`id -g` \
                  --force-rm -t ${DOCKER_REPOSITORY}:${TRAVIS_COMMIT} --pull=true .
              - docker login -u="${DOCKER_USERNAME}" -p="${DOCKER_PASSWORD}"
              - docker push ${DOCKER_REPOSITORY}

        - stage: build
          before_script: *update
          script:
              - docker run -dit --name travis_build ${DOCKER_REPOSITORY}:${TRAVIS_COMMIT} bash
              - docker exec -u 0 -ti travis_build bash -c "echo ${MACHINE_ID} > /etc/machine-id"
              - docker exec -ti travis_build meson build
              - docker exec -ti travis_build ninja -C build
                # Commit it to the new image that will be used for testing
              - docker commit -m "systemd build state" -a "${AUTHOR_NAME}" travis_build ${DOCKER_REPOSITORY}:${TRAVIS_COMMIT}
              - docker login -u="${DOCKER_USERNAME}" -p="${DOCKER_PASSWORD}"
              - docker push ${DOCKER_REPOSITORY}:${TRAVIS_COMMIT}

        - stage: test
          before_script: *update
          script:
              - docker run --privileged --net=host -dit --name travis_test ${DOCKER_REPOSITORY}:${TRAVIS_COMMIT} bash
              - docker exec -ti travis_test ninja -C build test
              - docker commit -m "systemd test state" -a "${AUTHOR_NAME}" travis_test ${DOCKER_REPOSITORY}:${TRAVIS_COMMIT}
              - docker login -u="${DOCKER_USERNAME}" -p="${DOCKER_PASSWORD}"
              - docker push ${DOCKER_REPOSITORY}:${TRAVIS_COMMIT}

        - stage: coverity scan
          before_script: *update
          env:
              - COVERITY_SCAN_PROJECT_NAME=CermakM/systemd # FIXME
              - COVERITY_SCAN_NOTIFICATION_EMAIL="${AUTHOR_EMAIL}"
              - COVERITY_SCAN_BRANCH_PATTERN=travis-docker # FIXME
                # Disable CCACHE for cov-build to compilation units correctly
              - CCACHE_DISABLE=1
              # The next declration is the encrypted COVERITY_SCAN_TOKEN, created
              #   via the "travis encrypt" command using the project repo's public key
              #   Token for test systemd project
              - secure: "FOfIhGZcIViZtG7hHu5WSSgtuD0BcIr+AkTvBCosFX4cgNAxy7SAXcoq/7Nod2i6gceSY0OyoDVt2MY5Iy9wfU6wMklkpqZim/F/sdihrBjJWnybwVPROcZrXeCjJbdo5ak57KQ5p+hKPJRnPlTSUKzF14VXq6SGJV+jJq+wHj7r8NdC2+6owsh5zFrLarOL5d7yzPbQVBXQtkf2h+0o+ylKNT1OTASl4ba/HIgJaWYu1QQwiyNF7lmtZ2QEQG4t4+AYfI8//lDdiEv/sDAPfqmR+5hO/NCAn+nCIYbXULQoiuUg4pZ+As7lQS9Ti0yTlnnac7xo8TetNCNF/oZLQY5IXpZCHIFFJWI+9lxN+Ni2g79iKda9a9U1dyCJDd8kBixFvD2nFTjODjNE6GaADMTj6sSyaxLoBAJA0DZeGk95aqZK2BJHU+jqHTDL62S3etpu/Xsq/xCRzPQHL1NXMtS/Ne9v7LAEVlqpqPI1xAI+rJL2m5ZaAPM3MeufB2pleBcSHBBnaiy0ZPnfMVdZFWPPog7uoJTZsVB7ze4mwoeHKRMtjTfMYlGwf0hkPWyeUgn2m1Dvppq+vEeBI768g+LXXDytiqqjYdWnBYl4UBFnjjlufHvkZtZrg5psWEwhhHij+cqb4x7uy7avuVEX5GbGPZVPbjU8I0VpND0pl68="
              # Token for systemd/systemd
              # - secure: "UNQLspT89GYWuVKFqW5W5RyqqnYg5RvX20IrNraOddhpdV9nhKBtozrfmhGXDGZwfHGWHt6g7YROlD/NIMvDvThVJIEYvSQiXCoo2zRrwkl2siET5MjPfRG8numiLq0KX47KGmyBJISJZCgDUdNGqqGwgf7AhDN78I3XtgqjFT1z0mGl8n0wiFpKPi7i3nECvF4Mk7xCCHqwByaq0z5G9NkVlOvP1EyCxwv3B6I5Umfch7ibp7iH44YnVXILK+yEry5dMuctYwYkDouR80ChEPQQ5fhhpO4++HJmFuSpfMTeCHpucAd2xwSUijejYeN/GNQ177GxSSk/8hRBGcuSK8T/WJ+KiuJPhZObV8mw+a6+qdQssWY4F9jya5ZKbZ/yTbxjtQ0m4AgtL28P9bEze8pLh16zFMX+hIEuoFSNmJqmtNttfbD5TKyYVZml59s9wvhlvMnlNpRSQva88OAOjXtiA41g+XtTxxpfW9mgd7HYhzSBs1efNiK7PfkANgve7KIYMAmCAqasgb1IIAyX7stOlJH06QOFXNH55PmJLkkKyL3SMQzgryMDWegU+XbS8t43r0x14WLuE7sc9JtnOr/G8hthFaMRp8xLy9aCBwyEIkEsyWa50VMoZDa3Spdb4r1CKBwcGdCbyE4rCehwEIznbfrsSovhwiUds7bbhBU="
          script:
              # For kernel version 4.8+
              - sudo sysctl vsyscall=emulate || true
                # Make sure wget is installed
              - sudo apt-get update && sudo apt-get -y install wget
                # Prepare environment for Coverity tool
              - |
                  export TOOL_BASE="/tmp/coverity-scan-analysis"
                  export SCAN_URL="https://scan.coverity.com"
                  export UPLOAD_URL="https://scan.coverity.com/builds"
                  PLATFORM=`uname`
                  TOOL_ARCHIVE="/tmp/cov-analysis-${PLATFORM}.tgz"
                  TOOL_URL="https://scan.coverity.com/download/${PLATFORM}"
                # Get coverity tool
              - |
                  if [ ! -d $TOOL_BASE ]; then
                      # Download Coverity Scan Analysis Tool
                      if [ ! -e $TOOL_ARCHIVE ]; then
                          echo -e "\033[33;1mDownloading Coverity Scan Analysis Tool...\033[0m"
                          wget -nv -O $TOOL_ARCHIVE $TOOL_URL --post-data "project=$COVERITY_SCAN_PROJECT_NAME&token=$COVERITY_SCAN_TOKEN"
                      fi

                      # Extract Coverity Scan Analysis Tool
                      echo -e "\033[33;1mExtracting Coverity Scan Analysis Tool...\033[0m"
                      mkdir -p $TOOL_BASE
                      pushd $TOOL_BASE
                      tar xzf $TOOL_ARCHIVE
                      popd
                  fi
              - TOOL_DIR="$(find $TOOL_BASE -type d -name 'cov-analysis*')"

                # Add _Float128 to coverity templates to add support for GCC7+
              - |
                  find $TOOL_DIR -regex '.*/compiler-compat-g[c+]+.h' -exec sh -c '\
                                         printf "\n\
                                                 #if __GNUC__ == 7 && __GNUC_MINOR__ >= 1\n\
                                                 #define _Float128 long double\n\
                                                 #endif\n" >> $1' -- {} \;

                # Export env variables for Coverity scan
              - env | grep -E "TRAVIS|COV|TOOL|URL" > .cov-env
              - |
                  docker run -dit --env-file .cov-env \
                  -v ${TOOL_BASE}:${TOOL_BASE}:ro \
                  --name travis_coverity_scan ${DOCKER_REPOSITORY}:${TRAVIS_COMMIT} bash
                # Make sure Coverity script is executable
              - if [[ ! -x "${COVERITY_SCRIPT}" ]] ; then chmod +x ${COVERITY_SCRIPT} ; fi
              - docker cp ${COVERITY_SCRIPT} travis_coverity_scan:/usr/local/bin
              - docker exec -it travis_coverity_scan ${COVERITY_SCRIPT}
              - docker commit -m "systemd coverity scan analysis" -a "${AUTHOR_NAME}" travis_coverity_scan ${DOCKER_REPOSITORY}:${TRAVIS_COMMIT}
              - docker login -u="${DOCKER_USERNAME}" -p="${DOCKER_PASSWORD}"
              - docker push ${DOCKER_REPOSITORY}:${TRAVIS_COMMIT}

# Specify the order of stages and conditions
stages:
    - name: build docker image
    - name: build
      if: env(COVERITY_SCAN_BRANCH) != 1 AND type = cron # FIXME
    - name: test
      if: env(COVERITY_SCAN_BRANCH) != 1 AND type = cron # FIXME
    - name: coverity scan
      # if: type = cron FIXME

env:
    global:
        - MACHINE_ID=$(cat /var/lib/dbus/machine-id)
        - DOCKER_REPOSITORY=$DOCKER_USERNAME/systemd
        - AUTHOR_NAME="$(git log -1 $TRAVIS_COMMIT --pretty=\"%aN\")"
        - AUTHOR_EMAIL="$(git log -1 $TRAVIS_COMMIT --pretty=\"%aE\")"
        - TEST_LOG_FILE="build/meson-logs/testlog.txt"
        - COVERITY_SCRIPT="coverity.sh"

after_failure:
    # Same for both coverity and test build - coverity builds into the same folder
    - docker run  -it --name travis_log ${DOCKER_REPOSITORY}:${TRAVIS_COMMIT} bash -c "cat ${TEST_LOG_FILE}"

# Allow travis builds only for master branch
branches:
    only:
        travis-docker # FIXME

# notifications:
#   email:
#     recipients:
#       - ${ADMIN_EMAIL}
#       - ${AUTHOR_EMAIL}
#   irc:
#     channels:
#       - "irc.freenode.org#systemd"
#     on_success: change
#     on_failure: always
